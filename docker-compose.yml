version: '3.8'

services:
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: automotive-tests
    
    # Hardware device access - automatically managed by auto_docker.py
    # To add custom devices, create docker-compose.override.yml or use:
    # python scripts/auto_docker.py compose --platform your_platform
    devices: []  # Will be populated by auto_docker.py or override file
    
    # Required capabilities for network interfaces
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    
    # Use host network for CAN interfaces
    network_mode: host
    
    # Environment variables
    environment:
      - HARDWARE_PLATFORM=${HARDWARE_PLATFORM:-ecu_platform_a}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTEST_ARGS=${PYTEST_ARGS:--m smoke}
    
    # Volume mounts
    volumes:
      - ./reports:/app/reports
      - ./config:/app/config
      # Mount for live code changes during development
      - ./tests:/app/tests
      - ./framework:/app/framework
    
    # Command override (use env var or default)
    command: ${PYTEST_ARGS:--m smoke --alluredir=/app/reports/allure-results}

  # Optional: Mock service for testing without hardware
  mock-ecu:
    build:
      context: .
      dockerfile: Dockerfile.mock
    container_name: mock-ecu
    environment:
      - MOCK_CAN_INTERFACE=vcan0
    command: python -m framework.adapters.mock_adapter
    profiles:
      - mock  # Only start with: docker-compose --profile mock up

# Usage examples (RECOMMENDED - automatic device mapping):
# ./auto_test.sh my_platform -m smoke                         # Auto device mapping
# python scripts/auto_docker.py run --platform my_platform    # Direct auto mapping
# python scripts/auto_docker.py compose --platform my_platform && docker-compose up

# Usage examples (traditional):
# docker-compose up                                    # Run smoke tests
# docker-compose run test-runner -m can_bus           # Run CAN tests
# HARDWARE_PLATFORM=ecu_platform_b docker-compose up  # Use different platform
